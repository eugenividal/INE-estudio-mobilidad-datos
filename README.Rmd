---
title: "open-data-movilidad"
output: 
  github_document:
    html_preview: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE)
library(tidyverse)
library(sf)
library(tmap)
library(kableExtra)
tmap_mode("view")
sf::sf_use_s2(FALSE)
```


This repository contains code to access OD data (based on mobile phones locations) from the Ministry of Transport, Mobility and Urban Agenda (Spain). 

The raw data and some information on the method used to collect the data can be found in the link below. (Do not use Chromium to open the link or you won't be able to see the data!)

https://www.mitma.gob.es/ministerio/covid-19/evolucion-movilidad-big-data/opendata-movilidad 


```{r}
# Read the data
dist_202102 = read.table(gzfile("datos/202102_maestra1_mitma_distrito/20210201_maestra_1_mitma_distrito.txt.gz"), header = TRUE, sep = "|")

head(dist_202102)

dist_202102_2 = read.table(gzfile("datos/202102_maestra2_mitma_distrito/20210201_maestra_2_mitma_distrito.txt.gz"), header = TRUE, sep = "|")

names(dist_202102_2)

muni_202102 = read.table(gzfile("datos/202102_maestra1_mitma_municipio/20210201_maestra_1_mitma_municipio.txt.gz"), header = TRUE, sep = "|")

names(muni_202102)

muni_202102_2 = read.table(gzfile("datos/202102_maestra2_mitma_municipio/20210201_maestra_2_mitma_municipio.txt.gz"), header = TRUE, sep = "|")

names(muni_202102_2)

muni = read.table("relaciones_municipio_mitma.csv", header = TRUE, sep = "|")
dist = read.table("relaciones_distrito_mitma.csv", header = TRUE, sep = "|")

zonificacion_dist <- sf::st_read(
  "zonificacion_distritos/zonificacion-distritos/distritos_mitma.shp")

zonificacion_muni <- sf::st_read(
  "zonificacion_municipios/zonificacion-municipios/municipios_mitma.shp")


```

```{r}
# create province and district origin
dist_202102_2 = dist_202102 %>% 
  # slice_head(n = 10) %>%
  separate(origen, into = c("prov_O", "dist_O"), sep = 2, remove = FALSE)  

#filter potetial cyclable trips (< 10km) 
dist_202102_3 = dist_202102_2 %>% 
  filter(distancia == "002-005" | distancia == "005-010") %>% 
  group_by(origen, prov_O, dist_O) %>% 
  summarise("num. trips <10 km"= sum(viajes))

# add geometry origin
dist_202102_4 = dist_202102_3 %>% 
  left_join(zonificacion_dist, by = c("origen" = "ID"))

# Filter the Catalan Countries
dist_202102_5 = dist_202102_4 %>% 
   filter(prov_O == "03" | prov_O == "46" | prov_O == "12" | prov_O == "43" | prov_O == "08"  | prov_O == "25"  | prov_O == "17"
          | prov_O == "07")

# Plot map
dist_202102_5 = st_sf(dist_202102_5)


qtm(dist_202102_5, "num. trips <10 km")
```

Fig 1: Number of trips under 10 km by district on February 2021